<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mimibox</title>
    <link rel="shortcut icon" type="image/png" href="favicon-32x32.png"/>
    <script src="sjcl.js"></script>
    <style>
        @font-face {
            font-family: "Lato Light";
            src: url("Lato-Light.ttf");
        }

        body {
            padding: 1em 5em;
            font-family: "Lato Light", sans-serif;
        }

        h1, p {
            text-align: center;
        }

        img {
            height: 48px;
        }

        fieldset {
            border: 1px solid gray;
            border-radius: 0.8em;
            margin: 1em 0;
            padding: 1em 1.2em 1.5em 1.2em;
        }

        legend {
            border: 1px solid gray;
            border-radius: 0.5em;
            padding: 0.3em 0.7em 0.5em 0.7em;
        }

        input {
            margin-right: 1em;
        }

        button {
            border: 1px solid lightgray;
            line-height: 2em;
            padding: 0 1em;
        }

        button:hover {
            background: lightgray
        }

        table {
            border-collapse: collapse;
        }

        tr {
            border-bottom: 1px solid lightgray;
        }

        td {
            padding: 1em;
        }
    </style>
</head>
<body>

<h1>
    Mimibox
</h1>

<p>This page will reset in <span id="timer"></span> minutes to help protect your data. Please save any changes before then.</p>

<fieldset>
    <legend>Open file</legend>
    <input type="file" id="file">
    <label for="load-password">Password</label>
    <input type="password" id="load-password">
    <button id="load">Load</button>
</fieldset>

<fieldset>
    <legend>Save file</legend>
    <label for="save-password">Password</label>
    <input type="password" id="save-password">
    <label for="confirm-save-password">Confirm password</label>
    <input type="password" id="confirm-save-password">
    <button id="save">Save</button>
</fieldset>

<fieldset>
    <legend>Add entry</legend>
    <label for="new-entry-name">Name</label>
    <input type="text" id="new-entry-name">
    <label for="new-entry-username">Username</label>
    <input type="text" id="new-entry-username">
    <label for="new-entry-password">Password</label>
    <input type="text" id="new-entry-password">
    <button id="add">Add</button>
</fieldset>

<table id="entries"></table>

<script>
  const ONE_MINUTE_IN_MS = 60000;
  let minutesBeforeClear = 60;
  const timer = document.getElementById("timer");
  timer.textContent = minutesBeforeClear.toString();
  setInterval(() => {
    minutesBeforeClear -= 1;
    timer.textContent = minutesBeforeClear.toString();
    if (minutesBeforeClear === 0) {
      window.location.reload();
    }
  }, ONE_MINUTE_IN_MS);

  const mimibox = {
    entries: [
      {id: '1342423423423', name: 'Website #1', username: 'myusername1', password: 'mypassword1'},
      {id: '3565634353453', name: 'Website #2', username: 'myusername2', password: 'mypassword2'}
    ],
  };

  const ENTER_KEY = 13;

  const updateUI = () => {
    const entriesUI = document.getElementById("entries");

    while (entriesUI.hasChildNodes()) {
      entriesUI.removeChild(entriesUI.firstChild);
    }

    for (let i = 0; i < mimibox.entries.length; i++) {
      const entry = mimibox.entries[i];
      const {id, name, username, password} = entry;

      const nameUI = document.createElement("td");
      nameUI.textContent = name;

      const usernameUI = document.createElement("td");
      usernameUI.textContent = username;

      const passwordUI = document.createElement("td");
      passwordUI.textContent = password;

      const copyPasswordButton = document.createElement("button");
      copyPasswordButton.textContent = "Copy password";
      copyPasswordButton.onclick = () => {
        navigator.clipboard.writeText(password).finally(() => {
          setTimeout(() => {
            navigator.clipboard.writeText("");
          }, 10000);
        });
      };

      const copyPasswordButtonContainer = document.createElement("td");
      copyPasswordButtonContainer.appendChild(copyPasswordButton);

      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Delete";
      deleteButton.onclick = () => {
        const prevEntries = mimibox.entries;
        const nextEntries = prevEntries.filter(entry => entry.id !== id);
        mimibox.entries = nextEntries;
        updateUI();
      };
      const deleteButtonContainer = document.createElement("td");
      deleteButtonContainer.appendChild(deleteButton);

      const entryUI = document.createElement("tr");
      entryUI.id = id;
      entryUI.appendChild(nameUI);
      entryUI.appendChild(usernameUI);
      entryUI.appendChild(passwordUI);
      entryUI.appendChild(copyPasswordButtonContainer);
      entryUI.appendChild(deleteButtonContainer);

      entriesUI.appendChild(entryUI);
    }
  };

  updateUI();

  const addButton = document.getElementById("add");
  addButton.onclick = () => {
    const nameElement = document.getElementById("new-entry-name");
    const name = nameElement.value;
    const usernameElement = document.getElementById("new-entry-username");
    const username = usernameElement.value;
    const passwordElement = document.getElementById("new-entry-password");
    const password = passwordElement.value;
    if (!name) {
      alert('Please enter a name.');
      return;
    }
    mimibox.entries.unshift({
      id: Date.now(),
      name,
      username,
      password,
    });
    updateUI();
    nameElement.value = '';
    usernameElement.value = '';
    passwordElement.value = '';
    nameElement.focus();
  };

  document.getElementById("new-entry-password").onkeydown = e => {
    if (e.keyCode !== ENTER_KEY) {
      return;
    }
    addButton.click();
  };

  function download(data, filename, type) {
    const file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
      const a = document.createElement("a"),
        url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function () {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    }
  }

  // Save
  const saveButton = document.getElementById("save");
  saveButton.onclick = () => {
    const entriesAsString = JSON.stringify(mimibox.entries);
    const savePassword = document.getElementById("save-password").value;
    if (!savePassword) {
      alert('Please enter a password.');
      return;
    }
    const confirmSavePassword = document.getElementById("confirm-save-password").value;
    if (savePassword !== confirmSavePassword) {
      alert('Passwords do not match.');
      return;
    }
    const encrypted = sjcl.encrypt(savePassword, entriesAsString);
    download(encrypted, "mimibox.dat", 'text/plain');
  };

  document.getElementById("confirm-save-password").onkeydown = e => {
    if (e.keyCode !== ENTER_KEY) {
      return;
    }
    saveButton.click();
  };

  // Load
  const loadPasswordElement = document.getElementById("load-password");

  const loadButton = document.getElementById("load");
  loadButton.onclick = () => {
    const selectedFile = document.getElementById("file").files[0];
    if (!selectedFile) {
      alert('Please select a file');
      return;
    }
    const loadPassword = loadPasswordElement.value;
    if (!loadPassword) {
      alert('Please enter a password.');
      return;
    }
    const reader = new FileReader();
    reader.onload = event => {
      const encrypted = event.target.result;
      let decrypted;
      try {
        decrypted = sjcl.decrypt(loadPassword, encrypted);
      } catch (error) {
        alert('Incorrect password.');
        loadPasswordElement.value = '';
        loadPasswordElement.focus();
      }
      const entries = JSON.parse(decrypted);
      mimibox.entries = entries;
      updateUI();
    };
    reader.readAsText(selectedFile);
  };

  const fileInput = document.getElementById("file");
  fileInput.onchange = () => {
    loadPasswordElement.focus();
  };

  fileInput.focus();

  document.getElementById("load-password").onkeydown = e => {
    if (e.keyCode !== ENTER_KEY) {
      return;
    }
    loadButton.click();
  };
</script>
</body>
</html>