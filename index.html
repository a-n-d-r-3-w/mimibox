<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mimibox</title>
    <link rel="shortcut icon" type="image/png" href="favicon-32x32.png"/>
    <link rel="stylesheet" href="fontawesome/css/fontawesome-all.min.css"/>
    <script src="sjcl.js"></script>
    <style>
        @font-face {
            font-family: "Lato Light";
            src: url("Lato-Light.ttf");
        }

        body {
            padding: 1em 5em;
            font-family: "Lato Light", sans-serif;
        }

        h1, p {
            text-align: center;
        }

        img {
            height: 48px;
        }

        fieldset {
            border: 1px solid gray;
            border-radius: 0.8em;
            margin: 1em 0;
            padding: 1em 1.2em 1.5em 1.2em;
        }

        legend {
            border: 1px solid gray;
            border-radius: 0.5em;
            padding: 0.3em 0.7em 0.5em 0.7em;
        }

        input {
            margin-right: 1em;
        }

        .rectangular-button {
            border: 1px solid lightgray;
            border-radius: 0.5em;
            line-height: 2em;
            padding: 0 1em;
        }

        .rectangular-button:hover {
            background: lightgray
        }

        i {
            color: gray;
            margin: 0 0.5em;
            position: relative; /* To position child tooltip element */
        }

        i .tooltip {
            display: none;
            font-family: "Lato Light", sans-serif;
            font-size: 0.75em;
            /* "width" should be set in JavaScript. */
            background-color: dodgerblue;
            color: white;
            text-align: center;
            border-radius: 0.5em;
            padding: 4px 0;
            position: absolute;
            top: -2em;
            /* "left" should be set in JavaScript. */
            z-index: 1;
        }

        i:hover {
            color: dodgerblue;
        }

        i:hover .tooltip {
            display: inline;
        }

        table {
            border-collapse: collapse;
        }

        tr {
            border-bottom: 1px solid lightgray;
        }

        td {
            padding: 0.5em;
        }
        
        #filter {
            text-align: center;
        }

        #filter-input {
            width: 26em;
            text-align: center;
        }

        .button-group {
            margin: 1em;
        }

        #file {
            display: none;
        }
    </style>
</head>
<body>

<h1>
    Mimibox
</h1>

This page will reset in <span id="timer"></span> minutes to protect your data. Please export any changes before then.

<div class="button-group">
    <button class="rectangular-button" id="import">Import</button>
    <button class="rectangular-button" id="export">Export</button>
</div>
<input type="file" id="file">

<fieldset>
    <legend>Add entry</legend>
    <label for="new-entry-name">Name</label>
    <input type="text" id="new-entry-name">
    <label for="new-entry-username">Username</label>
    <input type="text" id="new-entry-username">
    <label for="new-entry-password">Password</label>
    <input type="text" id="new-entry-password">
    <button id="add" class="rectangular-button">Add</button>
</fieldset>

<div id="filter">
    <label for="filter-input">Filter</label>
    <input type="text" id="filter-input" placeholder="ENTER copies first password; ESC clears filter">
</div>

<button class="rectangular-button" id="show-hide-passwords">Show/hide passwords</button>

<table id="entries"></table>

<dialog id="import-password-dialog">
    <label for="import-password">Enter import password:</label>
    <input id="import-password" type="password" />
</dialog>

<dialog id="export-password-dialog">
    <label for="export-password">Enter export password:</label>
    <input id="export-password" type="password" />
</dialog>

<dialog id="confirm-export-password-dialog">
    <label for="confirm-export-password">Confirm export password:</label>
    <input id="confirm-export-password" type="password" />
</dialog>

<script>
  const ONE_MINUTE_IN_MS = 60000;
  const TWENTY_SECONDS_IN_MS = 20000;
  let minutesBeforeClear = 60;
  const timer = document.getElementById("timer");
  timer.textContent = minutesBeforeClear.toString();
  setInterval(() => {
    minutesBeforeClear -= 1;
    timer.textContent = minutesBeforeClear.toString();
    if (minutesBeforeClear === 0) {
      window.location.reload();
    }
  }, ONE_MINUTE_IN_MS);

  let showPasswords = false;
  let selectedFile = null;
  let exportPassword = null;

  const importButton = document.getElementById("import");
  const fileInput = document.getElementById("file");
  const importPasswordDialog = document.getElementById("import-password-dialog");
  const importPasswordInput = document.getElementById("import-password");

  const exportButton = document.getElementById("export");
  const exportPasswordDialog = document.getElementById("export-password-dialog");
  const exportPasswordInput = document.getElementById("export-password");
  const confirmExportPasswordDialog = document.getElementById("confirm-export-password-dialog");
  const confirmExportPasswordInput = document.getElementById("confirm-export-password");

  const newEntryNameInput = document.getElementById("new-entry-name");
  const newEntryUsernameInput = document.getElementById("new-entry-username");
  const newEntryPasswordInput = document.getElementById("new-entry-password");
  const addButton = document.getElementById("add");

  const filterInput = document.getElementById("filter-input");
  const showHidePasswordButton = document.getElementById("show-hide-passwords");
  const entriesUi = document.getElementById("entries");

  const mimibox = {
    entries: [
      {id: '1342423423423', name: 'GitHub', username: 'eldrago', password: 'yV~@~%{a+9PS,+%\\#'},
      {id: '3565634353453', name: 'JetBrains', username: 'wonderboom', password: 'BddhaXJK'}
    ],
  };

  const ENTER_KEY = 13;
  const ESCAPE_KEY = 27;

  const updateUi = filterText => {

    while (entriesUi.hasChildNodes()) {
      entriesUi.removeChild(entriesUi.firstChild);
    }

    let taggedFirstPasswordButton = false;

    for (let i = 0; i < mimibox.entries.length; i++) {
      const entry = mimibox.entries[i];
      const {id, name, username, password} = entry;

      if (filterText && name.toLowerCase().indexOf(filterText.toLowerCase()) === -1) {
        continue;
      }

      const nameUi = document.createElement("td");
      nameUi.textContent = name;

      const usernameUi = document.createElement("td");
      usernameUi.textContent = username;

      const copyPasswordButton = document.createElement("i");
      copyPasswordButton.classList.add("fas");
      copyPasswordButton.classList.add("fa-copy");
      copyPasswordButton.onclick = () => {
        navigator.clipboard.writeText(password).finally(() => {
          alert(`${name} password copied. Clipboard will be cleared in ${TWENTY_SECONDS_IN_MS/1000} seconds.`);
          setTimeout(() => {
            navigator.clipboard.writeText("");
          }, TWENTY_SECONDS_IN_MS);
        });
      };

      if (!taggedFirstPasswordButton) {
        copyPasswordButton.id = 'first-copy-password-button';
        taggedFirstPasswordButton = true;
      }

      const copyPasswordTooltip = document.createElement("span");
      copyPasswordTooltip.classList.add("tooltip");
      copyPasswordTooltip.textContent = "Copy password";
      copyPasswordTooltip.style.width = "8em";
      copyPasswordTooltip.style.left = "-3.5em";

      copyPasswordButton.appendChild(copyPasswordTooltip);

      const passwordUiText = document.createElement("span");
      passwordUiText.textContent = showPasswords ? password : '················';

      const passwordUi = document.createElement("td");
      passwordUi.appendChild(copyPasswordButton);
      passwordUi.appendChild(passwordUiText);

      const deleteButton = document.createElement("i");
      deleteButton.classList.add("fas");
      deleteButton.classList.add("fa-trash");
      deleteButton.onclick = () => {
        let isUserSure = confirm("Are you sure?");
        if (!isUserSure) {
          return;
        }
        const prevEntries = mimibox.entries;
        const nextEntries = prevEntries.filter(entry => entry.id !== id);
        mimibox.entries = nextEntries;
        updateUi();
      };

      const deleteTooltip = document.createElement("span");
      deleteTooltip.classList.add("tooltip");
      deleteTooltip.textContent = "Delete";
      deleteTooltip.style.width = "4em";
      deleteTooltip.style.left = "-1.5em";
      deleteButton.appendChild(deleteTooltip);

      const deleteButtonContainer = document.createElement("td");
      deleteButtonContainer.appendChild(deleteButton);

      const entryUi = document.createElement("tr");
      entryUi.id = id;
      entryUi.appendChild(nameUi);
      entryUi.appendChild(usernameUi);
      entryUi.appendChild(passwordUi);
      entryUi.appendChild(deleteButtonContainer);

      entriesUi.appendChild(entryUi);
    }
  };

  updateUi();

  addButton.onclick = () => {
    const name = newEntryNameInput.value;
    const username = newEntryUsernameInput.value;
    const password = newEntryPasswordInput.value;
    if (!name) {
      alert('Please enter a name.');
      return;
    }
    mimibox.entries.unshift({
      id: Date.now(),
      name,
      username,
      password,
    });
    updateUi();
    newEntryNameInput.value = '';
    newEntryUsernameInput.value = '';
    newEntryPasswordInput.value = '';
    newEntryNameInput.focus();
  };

  newEntryPasswordInput.onkeydown = e => {
    if (e.keyCode !== ENTER_KEY) {
      return;
    }
    addButton.click();
  };

  function download(data, filename, type) {
    const file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
      const a = document.createElement("a"),
        url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function () {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    }
  }

  fileInput.onchange = () => {
    selectedFile = fileInput.files[0];
    if (!selectedFile) {
      return;
    }
    fileInput.value = '';
    importPasswordDialog.showModal();
  };

  importButton.onclick = () => {
    fileInput.click();
  };
  importButton.focus();

  exportButton.onclick = () => {
    exportPasswordDialog.showModal();
  };

  showHidePasswordButton.onclick = () => {
    showPasswords = !showPasswords;
    updateUi();
  };

  filterInput.onkeyup = e => {
    const filterText = e.target.value;
    updateUi(filterText);
  };

  filterInput.onkeydown = e => {
    if (e.keyCode === ENTER_KEY) {
      document.getElementById('first-copy-password-button').click();
      return;
    }
    if (e.keyCode === ESCAPE_KEY) {
      e.target.value = '';
    }
  };

  importPasswordInput.onkeydown = e => {
    if (e.keyCode === ENTER_KEY && e.target.value) {
      const importPassword = e.target.value;
      e.target.value = '';
      const reader = new FileReader();
      reader.onload = event => {
        const encrypted = event.target.result;
        let decrypted;
        try {
          decrypted = sjcl.decrypt(importPassword, encrypted);
        } catch (error) {
          alert('Incorrect password');
          importPasswordDialog.close();
          importButton.focus();
          return;
        }
        const entries = JSON.parse(decrypted);
        mimibox.entries = entries;
        updateUi();
        importPasswordDialog.close();
        filterInput.focus();
      };
      reader.readAsText(selectedFile);
    }
    if (e.keyCode === ESCAPE_KEY) {
      e.target.value = '';
      importPasswordDialog.close();
      importButton.focus();
    }
  };

  exportPasswordInput.onkeydown = e => {
    if (e.keyCode === ENTER_KEY && e.target.value) {
      exportPassword = e.target.value;
      e.target.value = '';
      exportPasswordDialog.close();
      confirmExportPasswordDialog.showModal();
    }
    if (e.keyCode === ESCAPE_KEY) {
      e.target.value = '';
      exportPassword = null;
      exportPasswordDialog.close();
      exportButton.focus();
    }
  };

  confirmExportPasswordInput.onkeydown = e => {
    if (e.keyCode === ENTER_KEY && e.target.value) {
      const confirmExportPassword = e.target.value;
      e.target.value = '';
      if (confirmExportPassword !== exportPassword) {
        exportPassword = null;
        confirmExportPasswordDialog.close();
        alert('Passwords do not match');
        setTimeout(() => {
          exportButton.focus();
        }, 100); // Delay required before focus(), or else the export-password-dialog is opened again.
        return;
      }
      const entriesAsString = JSON.stringify(mimibox.entries);
      const encrypted = sjcl.encrypt(exportPassword, entriesAsString);
      download(encrypted, "mimibox.dat", 'text/plain');
      confirmExportPasswordDialog.close();
    }
    if (e.keyCode === ESCAPE_KEY) {
      e.target.value = '';
      exportPassword = null;
      confirmExportPasswordDialog.close();
      exportButton.focus();
    }
  }
</script>
</body>
</html>