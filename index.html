<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mimibox</title>
    <script src="sjcl.js"></script>
    <script src="main.js"></script>
    <style>
        button {
            margin: 1em;
        }

        td {
            padding: 1em;
        }
    </style>
</head>
<body>

<button id="add-entry">Add entry</button>

<button id="save">Save</button>

<table id="entries"></table>

<script>

  const updateUI = () => {
    const entriesUI = document.getElementById("entries");

    while (entriesUI.hasChildNodes()) {
      entriesUI.removeChild(entriesUI.firstChild);
    }

    for (let i = 0; i < mimibox.entries.length; i++) {
      const entry = mimibox.entries[i];
      const {name, username, password} = entry;

      const nameUI = document.createElement("td");
      nameUI.innerHTML = name;

      const usernameUI = document.createElement("td");
      usernameUI.innerHTML = username;

      const passwordUI = document.createElement("td");
      passwordUI.innerHTML = password;

      const entryUI = document.createElement("tr");
      entryUI.appendChild(nameUI);
      entryUI.appendChild(usernameUI);
      entryUI.appendChild(passwordUI);

      entriesUI.appendChild(entryUI);
    }
  };

  updateUI();

  document.getElementById("add-entry").onclick = () => {
    mimibox.entries.push({
      name: 'Gmail ' + Date.now(),
      username: 'myusername',
      password: 'mypassword',
    });
    updateUI();
  };

  function download(data, filename, type) {
    const file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
      const a = document.createElement("a"),
        url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    }
  }

  document.getElementById("save").onclick = () => {
    const entriesAsString = JSON.stringify(mimibox.entries);
    console.log('entriesAsString', entriesAsString);
    const encrypted = sjcl.encrypt('mypassword', entriesAsString);
    console.log('encrypted', encrypted);
    download(encrypted, "mimibox.dat", 'text/plain');

  };
</script>
</body>
</html>